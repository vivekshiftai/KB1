# Current Query Flow with LangGraph

## ğŸ”„ Complete Query Processing Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    QUERY ENDPOINT                               â”‚
â”‚  POST /query                                                    â”‚
â”‚  { "query": "What are safety requirements?", "pdf_name": "..." }â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LangGraphQueryProcessor.process_query()            â”‚
â”‚  - Initialize state with query, PDF name, chunk size = 3       â”‚
â”‚  - Execute LangGraph workflow                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LANGGRAPH WORKFLOW                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Initialize   â”‚â”€â”€â”€â–¶â”‚ 2. Retrieve     â”‚â”€â”€â”€â–¶â”‚ 3. Generate     â”‚
â”‚    Query        â”‚    â”‚    Chunks       â”‚    â”‚    LLM Response â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ - Check PDF     â”‚    â”‚ - Query vector  â”‚    â”‚ - Process with  â”‚
â”‚   exists        â”‚    â”‚   DB with 3     â”‚    â”‚   Azure AI      â”‚
â”‚ - Validate      â”‚    â”‚   chunks        â”‚    â”‚ - Generate      â”‚
â”‚   collection    â”‚    â”‚ - Get embedded  â”‚    â”‚   response      â”‚
â”‚                 â”‚    â”‚   images        â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Validate Response Quality                                    â”‚
â”‚                                                                 â”‚
â”‚ - Check response length (>50 chars)                            â”‚
â”‚ - Check if mentions query terms                                â”‚
â”‚ - Check if uses chunks                                         â”‚
â”‚ - Calculate confidence score (0.0-1.0)                        â”‚
â”‚                                                                 â”‚
â”‚ Confidence = has_content(0.3) + mentions_query(0.3) +          â”‚
â”‚              uses_chunks(0.2) + response_length(0.2)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Decision Logic                                               â”‚
â”‚                                                                 â”‚
â”‚ IF confidence >= 0.6 AND response is adequate:                 â”‚
â”‚   â””â”€â–¶ Go to Finalize Response                                  â”‚
â”‚                                                                 â”‚
â”‚ IF confidence < 0.7 OR needs human review:                     â”‚
â”‚   â””â”€â–¶ Go to Human Decision (simulated)                         â”‚
â”‚                                                                 â”‚
â”‚ IF iteration < 3:                                               â”‚
â”‚   â””â”€â–¶ Go to Increase Chunk Size                                â”‚
â”‚                                                                 â”‚
â”‚ IF iteration >= 3:                                              â”‚
â”‚   â””â”€â–¶ Go to Finalize Response                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6A. Human Decision (Simulated)                                 â”‚
â”‚                                                                 â”‚
â”‚ IF confidence >= 0.8:                                          â”‚
â”‚   â””â”€â–¶ Decision = "process"                                     â”‚
â”‚                                                                 â”‚
â”‚ IF confidence >= 0.6:                                          â”‚
â”‚   â””â”€â–¶ Decision = "requery"                                     â”‚
â”‚                                                                 â”‚
â”‚ ELSE:                                                           â”‚
â”‚   â””â”€â–¶ Decision = "requery"                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6B. Increase Chunk Size                                         â”‚
â”‚                                                                 â”‚
â”‚ - Current size: 3 â†’ 5 â†’ 7                                      â”‚
â”‚ - Increment: +2 each time                                       â”‚
â”‚ - Increment iteration counter                                   â”‚
â”‚                                                                 â”‚
â”‚ IF iteration < 3:                                               â”‚
â”‚   â””â”€â–¶ Go back to Retrieve Chunks (with new size)               â”‚
â”‚                                                                 â”‚
â”‚ IF iteration >= 3:                                              â”‚
â”‚   â””â”€â–¶ Go to Finalize Response                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Finalize Response                                            â”‚
â”‚                                                                 â”‚
â”‚ - Collect embedded images from used chunks                     â”‚
â”‚ - Collect tables from used chunks                              â”‚
â”‚ - Match chunks used by LLM                                     â”‚
â”‚ - Create QueryResponse object                                  â”‚
â”‚ - Calculate processing time                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RETURN RESPONSE                              â”‚
â”‚                                                                 â”‚
â”‚ QueryResponse {                                                 â”‚
â”‚   success: true,                                               â”‚
â”‚   message: "Query processed successfully...",                  â”‚
â”‚   response: "LLM generated response...",                       â”‚
â”‚   chunks_used: ["Section 1", "Section 2"],                    â”‚
â”‚   images: [ImageData objects with base64 data],                â”‚
â”‚   tables: ["<table>...</table>"],                              â”‚
â”‚   processing_time: "2.34s"                                     â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Retry Loop Example

```
Iteration 1: 3 chunks â†’ Confidence: 0.4 â†’ Retry with 5 chunks
Iteration 2: 5 chunks â†’ Confidence: 0.7 â†’ Process (good enough)
Iteration 3: 7 chunks â†’ (if still needed)
```

## ğŸ“Š Key Features

1. **Automatic Quality Assessment**: Each response gets a confidence score
2. **Progressive Chunk Increase**: 3 â†’ 5 â†’ 7 chunks for better context
3. **Maximum 3 Iterations**: Prevents infinite loops
4. **Embedded Images**: Images stored directly in chunks (base64)
5. **Smart Decision Making**: Automatically decides retry vs. finalize
6. **Same API**: Maintains existing endpoint structure

## ğŸ¯ Quality Metrics

- **has_content**: Response has meaningful content (0.3 weight)
- **mentions_query**: Response mentions query terms (0.3 weight)  
- **uses_chunks**: Response references retrieved chunks (0.2 weight)
- **response_length**: Response is sufficiently long (0.2 weight)

## ğŸš€ Benefits

- **Better Responses**: More context with increased chunks
- **Quality Control**: Automatic validation of response quality
- **Efficient**: Only retries when necessary
- **Reliable**: Maximum iteration limit prevents hanging
- **Fast**: Embedded images don't require additional queries
